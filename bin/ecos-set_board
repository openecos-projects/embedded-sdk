#!/usr/bin/env bash
set -euo pipefail

# ECOS `set_board` subcommand
# Sets the board configuration for the project

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
SDK_ROOT="$(dirname "$SCRIPT_DIR")"

# Color output
log() { echo -e "\033[1;32m[ECOS]\033[0m $*"; }
warn() { echo -e "\033[1;33m[WARN]\033[0m $*"; }
err() { echo -e "\033[1;31m[ERROR]\033[0m $*"; }

board_name=""
project_type=""

# Check if inside a project directory
check_project_dir() {
    if [[ ! -f "Makefile" ]] && [[ ! -f ".ecos-project" ]]; then
        err "Not an ECOS project directory."
        err "Run this command in a directory containing a Makefile or .ecos-project file."
        exit 1
    fi
}

get_config() {
    source .ecos-project

    board_name="${BOARD}"
    project_type="${TYPE:-}"

    echo "Project type: $project_type"
    echo "Board name: $board_name"
}

rewrite_config() {
    echo "BOARD=$target_board_name" > ".ecos-project"
    echo "TYPE=$project_type" >> ".ecos-project"
}
# Set board configuration
set_board() {
    local target_board_name="$1"

    check_project_dir
    rewrite_config
    get_config

    if [[ "$project_type" == "asm" ]]; then
        rm -f Makefile
        log "Removed Makefile for assembly project."
        log "Board configuration set to: $target_board_name"
        cp "$SDK_ROOT/board/${target_board_name}/Makefile_asm" "./Makefile"
        exit 0
    fi

    case "$target_board_name" in
        "c1")
            local board_file="board.h"
            local make_file="Makefile"
            local lds_file="sections.lds"
            # local start_file="start.s" # C1 might not have start.s in board dir yet, checking...

            local board_source_path="$SDK_ROOT/board/StarrySkyC1/$board_file"
            local make_source_path="$SDK_ROOT/board/StarrySkyC1/$make_file"
            local lds_source_path="$SDK_ROOT/board/StarrySkyC1/$lds_file"
            
            local board_target_path="./board.h"
            local make_target_path="./Makefile"
            local lds_target_path="./sections.lds"

            if [[ ! -f "$board_source_path" ]]; then
                err "Board config file not found: $board_source_path"
                exit 1
            fi

            # Copy board config file
            cp "$board_source_path" "$board_target_path"
            log "Set board configuration to: starrysky_c1"
            log "Config file: $board_target_path"

            # Copy Makefile
            cp "$make_source_path" "$make_target_path"
            log "Set Makefile: $make_target_path"

            # Copy Linker Script
            if [[ -f "$lds_source_path" ]]; then
                cp "$lds_source_path" "$lds_target_path"
                log "Set Linker Script: $lds_target_path"
            fi

            # Copy start.s if exists (C1 support)
            if [[ -f "$SDK_ROOT/board/StarrySkyC1/start.s" ]]; then
                cp "$SDK_ROOT/board/StarrySkyC1/start.s" "./start.s"
                log "Set startup code: ./start.s"
            fi

            # Update project config file if it exists
            if [[ -f ".ecos-project" ]]; then
                if grep -q "BOARD=" ".ecos-project"; then
                    sed -i "s/BOARD=.*/BOARD=$target_board_name/" ".ecos-project"
                else
                    echo "BOARD=$target_board_name" >> ".ecos-project"
                fi
                log "Updated project configuration file."
            fi
            ;;
        "c2")
            local board_file="board.h"
            local make_file="Makefile"
            local lds_file="sections.lds"
            local start_file="start.S"

            local board_source_path="$SDK_ROOT/board/StarrySkyC2/$board_file"
            local make_source_path="$SDK_ROOT/board/StarrySkyC2/$make_file"
            local lds_source_path="$SDK_ROOT/board/StarrySkyC2/$lds_file"
            local start_source_path="$SDK_ROOT/board/StarrySkyC2/$start_file"

            local board_target_path="./board.h"
            local make_target_path="./Makefile"
            local lds_target_path="./sections.lds"
            local start_target_path="./start.S"

            if [[ ! -f "$board_source_path" ]]; then
                err "Board config file not found: $board_source_path"
                exit 1
            fi

            # Copy board config file
            cp "$board_source_path" "$board_target_path"
            log "Set board configuration to: starrysky_c2"
            log "Config file: $board_target_path"

            # Copy Makefile
            cp "$make_source_path" "$make_target_path"
            log "Set Makefile: $make_target_path"

            # Copy Linker Script
            if [[ -f "$lds_source_path" ]]; then
                cp "$lds_source_path" "$lds_target_path"
                log "Set Linker Script: $lds_target_path"
            else
                warn "Linker script not found for C2: $lds_source_path"
            fi

            # Copy startup code
            if [[ -f "$start_source_path" ]]; then
                cp "$start_source_path" "$start_target_path"
                log "Set startup code: $start_target_path"
            else
                warn "Startup code not found for C2: $start_source_path"
            fi

            # Update project config file if it exists
            if [[ -f ".ecos-project" ]]; then
                if grep -q "BOARD=" ".ecos-project"; then
                    sed -i "s/BOARD=.*/BOARD=$target_board_name/" ".ecos-project"
                else
                    echo "BOARD=$target_board_name" >> ".ecos-project"
                fi
                log "Updated project configuration file."
            fi
            ;;
        "l3")
            local board_file="board.h"
            local make_file="Makefile"
            local lds_file="sections.lds"
            
            local board_source_path="$SDK_ROOT/board/StarrySkyL3/$board_file"
            local make_source_path="$SDK_ROOT/board/StarrySkyL3/$make_file"
            local lds_source_path="$SDK_ROOT/board/StarrySkyL3/$lds_file"

            local board_target_path="./board.h"
            local make_target_path="./Makefile"
            local lds_target_path="./sections.lds"

            if [[ ! -f "$board_source_path" ]]; then
                err "Board config file not found: $board_source_path"
                exit 1
            fi

            # Copy board config file
            cp "$board_source_path" "$board_target_path"
            log "Set board configuration to: starrysky_l3"
            log "Config file: $board_target_path"

            # Copy Makefile
            cp "$make_source_path" "$make_target_path"
            log "Set Makefile: $make_target_path"

            # Copy Linker Script
            if [[ -f "$lds_source_path" ]]; then
                cp "$lds_source_path" "$lds_target_path"
                log "Set Linker Script: $lds_target_path"
            fi
            
             # Copy start.s if exists
            if [[ -f "$SDK_ROOT/board/StarrySkyL3/start.s" ]]; then
                cp "$SDK_ROOT/board/StarrySkyL3/start.s" "./start.s"
                log "Set startup code: ./start.s"
            fi

            # Copy bootloader
            local bootloader_source_path="$SDK_ROOT/board/StarrySkyL3/loader"
            local bootloader_target_path="./loader"
            cp -r "$bootloader_source_path" "$bootloader_target_path"
            log "Set bootloader: $bootloader_target_path"

            # Update project config file if it exists
            if [[ -f ".ecos-project" ]]; then
                if grep -q "BOARD=" ".ecos-project"; then
                    sed -i "s/BOARD=.*/BOARD=$target_board_name/" ".ecos-project"
                else
                    echo "BOARD=$target_board_name" >> ".ecos-project"
                fi
                log "Updated project configuration file."
            fi
            ;;
        *)
            err "Unsupported board: $board_name"
            echo ""
            echo "Supported boards:"
            echo "  c1    StarrySky C1 board"
            echo "  c2    StarrySky C2 board"
            echo "  l3    StarrySky L3 board"
            exit 1
            ;;
    esac
}

# Main entry point for the subcommand
if [[ $# -eq 0 ]]; then
    err "Missing board name argument."
    echo ""
    echo "Usage: ecos set_board <board_name>"
    echo "Example: ecos set_board c1"
    exit 1
fi

set_board "$1"